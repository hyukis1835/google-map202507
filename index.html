<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>世界遺産マップ</title>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    let map;
    let currentInfoWindow = null;
    let currentMarker = null;

    function initMap() {
      const savedCenter = JSON.parse(localStorage.getItem("mapCenter"));
      const savedZoom = JSON.parse(localStorage.getItem("mapZoom"));
      const center = savedCenter || { lat: 41.9028, lng: 12.4964 };
      const zoom = savedZoom || 2;

      map = new google.maps.Map(document.getElementById("map"), {
        center: center,
        zoom: zoom,
        gestureHandling: "greedy", // PC: ホイールズームOK、スマホ: 2本指必要
        disableDoubleClickZoom: false,
        draggable: true
      });

      map.addListener("idle", () => {
        localStorage.setItem("mapCenter", JSON.stringify(map.getCenter().toJSON()));
        localStorage.setItem("mapZoom", JSON.stringify(map.getZoom()));
      });

      fetch("places.csv")
        .then(response => response.text())
        .then(csv => {
          const rows = csv.trim().split("\n").slice(1); // ヘッダをスキップ
          rows.forEach((line, index) => {
            const [name, lat, lng] = line.split(",");
            addMarker(name, parseFloat(lat), parseFloat(lng), index + 1);
          });
        });
    }

    function addMarker(name, lat, lng, index) {
      const marker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        label: {
          text: index.toString(),
          color: "white",
          fontWeight: "bold",
          fontSize: "14px"
        },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: "orange",
          fillOpacity: 1,
          strokeWeight: 2,
          strokeColor: "white"
        },
        title: name
      });

      marker.addListener("click", () => {
        if (currentInfoWindow && currentMarker === marker) {
          currentInfoWindow.close();
          currentInfoWindow = null;
          currentMarker = null;
        } else {
          if (currentInfoWindow) {
            currentInfoWindow.close();
          }
          const newWindow = new google.maps.InfoWindow({
            content: `<div style="font-size:14px;font-weight:bold">${name}</div>`,
            disableAutoPan: false
          });
          newWindow.open(map, marker);
          currentInfoWindow = newWindow;
          currentMarker = marker;
        }
      });
    }
  </script>

  <!-- ※ ご自身のAPIキーに置き換えてください -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap" async defer></script>
</body>
</html>

