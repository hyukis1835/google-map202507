<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>国別番号付きマーカーCSV読み込み地図</title>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0; padding: 0;
    }
    #map {
      touch-action: manipulation;
    }
    #csvFile {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 10;
      background: white;
      padding: 6px 12px;
      border-radius: 4px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <input type="file" id="csvFile" accept=".csv" />
  <div id="map"></div>

  <script>
    let map;
    let infoWindow;
    let markers = [];

    function isMobile() {
      return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    }

    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    function initMap() {
      const savedLat = parseFloat(localStorage.getItem("mapCenterLat"));
      const savedLng = parseFloat(localStorage.getItem("mapCenterLng"));
      const savedZoom = parseInt(localStorage.getItem("mapZoom"), 10);

      const defaultLatLng = {
        lat: savedLat || 35.681236,
        lng: savedLng || 139.767125,
      };
      const defaultZoom = savedZoom || 5;

      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultLatLng,
        zoom: defaultZoom,
        gestureHandling: isMobile() ? "greedy" : "auto",
        fullscreenControl: false,
        streetViewControl: false,
        mapTypeControl: false,
      });

      infoWindow = new google.maps.InfoWindow();

      map.addListener("idle", () => {
        const center = map.getCenter();
        localStorage.setItem("mapCenterLat", center.lat());
        localStorage.setItem("mapCenterLng", center.lng());
        localStorage.setItem("mapZoom", map.getZoom());
      });

      document.getElementById("csvFile").addEventListener("change", handleFileSelect);
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      clearMarkers();
      infoWindow.close();

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const lines = text.split(/\r?\n/);
        const countryCounters = {};

        lines.forEach(line => {
          if (!line.trim()) return; // 空行スキップ
          const cols = line.split(",");
          if (cols.length < 4) return; // 列数不足ならスキップ

          const country = cols[0].trim();
          const name = cols[1].trim();
          const lat = parseFloat(cols[2]);
          const lng = parseFloat(cols[3]);

          if (!country || !name || isNaN(lat) || isNaN(lng)) return;

          if (!countryCounters[country]) countryCounters[country] = 1;
          const number = countryCounters[country]++;

          const marker = new google.maps.Marker({
            position: { lat, lng },
            map,
            title: name,
            label: {
              text: number.toString(),
              color: "white",
              fontWeight: "bold",
              fontSize: "14px",
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 16,
              fillColor: "orange",
              fillOpacity: 1,
              strokeWeight: 2,
              strokeColor: "white",
            },
          });

          marker.addListener("click", () => {
            if (infoWindow.getMap()) {
              infoWindow.close();
              if (infoWindow.anchor === marker) return;
            }
            infoWindow.setContent(`${country} ${number}: ${name}`);
            infoWindow.open(map, marker);
          });

          markers.push(marker);
        });
      };
      reader.readAsText(file, "UTF-8");
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap">
  </script>
</body>
</html>
