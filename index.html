<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CSV自動読み込みマップ</title>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0; padding: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    let map;
    let infoWindow;
    let markers = [];

    function isMobile() {
      return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    }

    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    function initMap() {
      const savedLat = parseFloat(localStorage.getItem("mapCenterLat"));
      const savedLng = parseFloat(localStorage.getItem("mapCenterLng"));
      const savedZoom = parseInt(localStorage.getItem("mapZoom"), 10);

      const defaultLatLng = {
        lat: savedLat || 35.681236,
        lng: savedLng || 139.767125,
      };
      const defaultZoom = savedZoom || 5;

      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultLatLng,
        zoom: defaultZoom,
        gestureHandling: isMobile() ? "greedy" : "auto",
        fullscreenControl: false,
        streetViewControl: false,
        mapTypeControl: false,
      });

      infoWindow = new google.maps.InfoWindow();

      map.addListener("idle", () => {
        const center = map.getCenter();
        localStorage.setItem("mapCenterLat", center.lat());
        localStorage.setItem("mapCenterLng", center.lng());
        localStorage.setItem("mapZoom", map.getZoom());
      });

      loadCSVAndAddMarkers();
    }

    function loadCSVAndAddMarkers() {
      fetch('places.csv')
        .then(response => {
          if (!response.ok) {
            throw new Error('CSVファイルの読み込みに失敗しました');
          }
          return response.text();
        })
        .then(text => {
          const lines = text.split(/\r?\n/);
          const countryCounters = {};

          lines.forEach(line => {
            if (!line.trim()) return;
            const cols = line.split(",");
            if (cols.length < 4) return;

            const country = cols[0].trim();
            const name = cols[1].trim();
            const lat = parseFloat(cols[2]);
            const lng = parseFloat(cols[3]);

            if (!country || !name || isNaN(lat) || isNaN(lng)) return;

            if (!countryCounters[country]) countryCounters[country] = 1;
            const number = countryCounters[country]++;

            const marker = new google.maps.Marker({
              position: { lat, lng },
              map,
              title: name,
              label: {
                text: number.toString(),
                color: "white",
                fontWeight: "bold",
                fontSize: "14px",
              },
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 16,
                fillColor: "orange",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "white",
              },
            });

            marker.addListener("click", () => {
              if (infoWindow.getMap()) {
                infoWindow.close();
                if (infoWindow.anchor === marker) return;
              }
              infoWindow.setContent(`${country} ${number}: ${name}`);
              infoWindow.open(map, marker);
            });

            markers.push(marker);
          });
        })
        .catch(error => {
          console.error(error);
        });
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZPRJzf-rbyrdjWjmJYWYpb74dnfLjkHw&callback=initMap">
  </script>
</body>
</html>


